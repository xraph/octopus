# Octopus API Gateway Configuration Example

# Gateway server configuration
# Note: Environment variables can be used with ${ VAR } or ${ VAR:-default } syntax (without spaces)
gateway:
  # Listen address (IP:PORT)
  # Examples:
  #   listen: "0.0.0.0:8080"                    # Static value
  #   listen: "0.0.0.0:8080"                     # Or use env vars: GATEWAY_HOST and PORT with defaults
  listen: "0.0.0.0:8080"
  
  # Number of worker threads (0 = auto-detect CPU cores)
  workers: 0
  
  # Request timeout
  request_timeout: 30s
  
  # Graceful shutdown timeout (wait for in-flight requests)
  shutdown_timeout: 30s
  
  # Max request body size (in bytes)
  max_body_size: 10485760  # 10MB
  
  # TLS/HTTPS configuration (optional)
  # Uncomment to enable HTTPS
  # tls:
  #   # Certificate file (PEM format)
  #   cert_file: /etc/octopus/tls/cert.pem
  #   
  #   # Private key file (PEM format) 
  #   # Supports RSA, ECDSA, Ed25519
  #   key_file: /etc/octopus/tls/key.pem
  #   
  #   # Optional: Client CA certificate for mutual TLS (mTLS)
  #   # client_ca_file: /etc/octopus/tls/client-ca.pem
  #   
  #   # Require client certificates (mutual TLS)
  #   # require_client_cert: false
  #   
  #   # Minimum TLS version (1.2 or 1.3)
  #   # Default: 1.2 for compatibility
  #   min_tls_version: "1.2"
  #   
  #   # Enable automatic certificate reloading
  #   # Allows zero-downtime cert updates
  #   # Default: true
  #   enable_cert_reload: true
  #   
  #   # Certificate reload check interval (seconds)
  #   # Default: 300 (5 minutes)
  #   reload_interval_secs: 300
  
  # Compression configuration
  compression:
    # Enable/disable compression
    enabled: true
    
    # Compression level (1-9 for gzip/zstd, 1-11 for brotli)
    # Higher = better compression but slower
    # Default: 6 (balanced)
    level: 6
    
    # Minimum response size to compress (in bytes)
    # Responses smaller than this won't be compressed
    # Default: 1024 (1KB)
    min_size: 1024
    
    # Preferred compression algorithms in order of preference
    # Supported: br (brotli), zstd, gzip
    # Default: [br, zstd, gzip]
    algorithms:
      - br      # Brotli - best compression ratio
      - zstd    # Zstandard - fast with good compression
      - gzip    # Gzip - universal browser support

# NOTE: These sections are not yet implemented in the config loader
# They are included here as documentation for future features
#
# # Service discovery configuration
# discovery:
#   backend: kubernetes  # kubernetes, consul, etcd, dns, static
#   kubernetes:
#     namespace: default
#     label_selector: "app.kubernetes.io/managed-by=octopus"
#
# # FARP protocol configuration
# farp:
#   enabled: true
#   watch_interval: 5s
#   schema_cache_ttl: 5m

farp:
  enabled: true
  watch_interval: 5s
  schema_cache_ttl: 5m

  # Service discovery backends (optional)
  # Uncomment the backend(s) you want to use
  discovery:
    backends:
      # mDNS/Bonjour discovery for local development (Mac/Windows/Linux)
      # Automatically discovers services on the local network
      - type: mdns
        enabled: true
        config:
          service_type: "_octopus._tcp"  # Service type to discover
          domain: "local."                # mDNS domain
          watch_interval: 30s             # How often to poll for changes
          query_timeout: 5s               # Query timeout
          enable_ipv6: false               # Enable IPv6 discovery
      
      # Consul service discovery (for production)
      # - type: consul
      #   enabled: false
      #   config:
      #     address: "localhost:8500"
      #     datacenter: "dc1"
      #     token: ""                     # ACL token (optional)
      #     watch_interval: 10s
      
      # Kubernetes service discovery (for K8s deployments)
      # - type: kubernetes
      #   enabled: false
      #   config:
      #     namespace: "default"
      #     label_selector: "app=octopus-service"
      #     watch_interval: 10s
      
      # DNS-based discovery (for simple deployments)
      # - type: dns
      #   enabled: false
      #   config:
      #     default_port: 80
      #     watch_interval: 60s

# Middleware configuration
# Middleware runs for every request in the order defined
middleware:
  # Example: Request ID injection
  - type: request_id
    enabled: true
  
  # Example: CORS
  - type: cors
    enabled: true
    config:
      allowed_origins: ["*"]
      allowed_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      allowed_headers: ["*"]
      max_age: 3600

  # Example: Inline Rhai script (NEW!)
  # Scripts run in <100Î¼s with full request/response access
  - type: script
    enabled: true
    config:
      language: rhai  # rhai, lua (future), javascript (future), wasm (future)
      on_request: true  # Run on incoming requests
      on_response: false  # Run on outgoing responses
      timeout_ms: 100  # Max execution time
      # Inline script code
      code: |
        // Add custom headers
        headers["X-Gateway"] = "Octopus";
        headers["X-Request-Time"] = unix_time().to_string();
        
        // Add API versioning
        if uri.starts_with("/api/v1") {
          headers["X-API-Version"] = "1.0";
        }
        
        // Log for debugging
        log_debug("Processing request to: " + uri);
        
        // Return true to continue, false to short-circuit
        true

  # Example: Script from file
  - type: script
    enabled: true
    config:
      language: rhai
      file: /etc/octopus/scripts/auth-check.rhai
      on_request: true
      continue_on_error: false  # Fail request on script error

  # Example: Response transformation script
  - type: script
    enabled: true
    config:
      language: rhai
      on_request: false
      on_response: true  # Run on responses
      code: |
        // Add security headers
        headers["X-Frame-Options"] = "DENY";
        headers["X-Content-Type-Options"] = "nosniff";
        
        // Modify response body (if needed)
        if status == 200 {
          // Parse JSON response
          let body_json = parse_json(body);
          
          // Add metadata
          body_json["_meta"] = #{
            processed_by: "octopus",
            timestamp: unix_time()
          };
          
          // Update body
          body = to_json(body_json);
        }
        
        true

  # Example: JWT authentication
  - type: jwt
    enabled: true
    config:
      secret: "your-secret-key"
      algorithm: "HS256"

  # Example: Rate limiting
  - type: rate_limit
    enabled: true
    config:
      requests_per_second: 100
      burst: 200

# Plugin configuration
plugins:
  - name: jwt-auth
    plugin_type: static
    enabled: true
    priority: 100
    config:
      secret: "supersecret"
      algorithm: "HS256"
      issuer: "octopus-gateway"
  
  - name: rate-limiter
    plugin_type: static
    enabled: true
    priority: 90
    config:
      requests_per_second: 1000
      burst: 2000

# NOTE: Admin dashboard configuration is not yet implemented
# # Admin dashboard configuration
# admin:
#   enabled: true
#   address: 0.0.0.0:9090

# Observability configuration
observability:
  # Metrics (Prometheus-compatible)
  metrics:
    enabled: true
    endpoint: "0.0.0.0:9090"  # Prometheus metrics endpoint
  
  # Distributed tracing (Jaeger/OpenTelemetry)
  tracing:
    enabled: true
    jaeger_endpoint: "http://localhost:14268/api/traces"
  
  # Logging
  logging:
    level: info
    format: json  # json or text

# Static upstream configuration (optional, if not using FARP)
upstreams:
  - name: user-service
    lb_policy: round_robin
    instances:
      - id: user-service-1
        host: localhost
        port: 8081
        weight: 1
      - id: user-service-2
        host: localhost
        port: 8082
        weight: 1
    health_check:
      type: http
      path: /health
      interval: 10s
      timeout: 5s
      healthy_threshold: 2
      unhealthy_threshold: 3
    circuit_breaker:
      error_threshold: 0.5
      min_requests: 10
      timeout: 30s

# Static route configuration (optional, if not using FARP)
routes:
  - path: /api/users/*
    methods: [GET, POST, PUT, DELETE]
    upstream: user-service
    priority: 100
    strip_prefix: /api
  
  - path: /api/health
    methods: [GET]
    upstream: user-service
    priority: 90
  
  # WebSocket route example
  # WebSocket connections are automatically detected via Upgrade header
  # - path: /ws/*
  #   methods: [GET]
  #   upstream: websocket-service
  #   priority: 100
  #   # WebSocket-specific metadata (optional)
  #   metadata:
  #     max_message_size: "67108864"  # 64 MB
  #     max_frame_size: "16777216"    # 16 MB


