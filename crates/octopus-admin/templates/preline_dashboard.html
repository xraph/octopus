{% extends "shadcn_base.html" %}

{% block title %}Dashboard - Octopus Admin{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div x-data="prelineDashboard()" x-init="init()" class="p-5 md:p-8 space-y-5">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-800 dark:text-neutral-200">Dashboard Overview</h1>
            <p class="text-sm text-gray-600 dark:text-neutral-400">Monitor your API Gateway performance in real-time</p>
        </div>
        <div class="flex gap-x-2">
            <button @click="refresh()" type="button" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700">
                <svg class="flex-shrink-0 size-4" :class="{ 'animate-spin': loading }" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <!-- Total Requests -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="p-4 md:p-5">
                <div class="flex items-center gap-x-2">
                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-neutral-400">Total Requests</p>
                </div>
                <div class="mt-1 flex items-center gap-x-2">
                    <h3 class="text-xl sm:text-2xl font-medium text-gray-800 dark:text-neutral-200" x-text="formatNumber(stats.total_requests)">0</h3>
                </div>
            </div>
        </div>

        <!-- Active Routes -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="p-4 md:p-5">
                <div class="flex items-center gap-x-2">
                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-neutral-400">Active Routes</p>
                </div>
                <div class="mt-1 flex items-center gap-x-2">
                    <h3 class="text-xl sm:text-2xl font-medium text-gray-800 dark:text-neutral-200" x-text="stats.active_routes">0</h3>
                </div>
            </div>
        </div>

        <!-- Average Latency -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="p-4 md:p-5">
                <div class="flex items-center gap-x-2">
                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-neutral-400">Avg Latency</p>
                </div>
                <div class="mt-1 flex items-center gap-x-2">
                    <h3 class="text-xl sm:text-2xl font-medium text-gray-800 dark:text-neutral-200"><span x-text="stats.avg_latency_ms.toFixed(1)">0</span>ms</h3>
                </div>
            </div>
        </div>

        <!-- Error Rate -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="p-4 md:p-5">
                <div class="flex items-center gap-x-2">
                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-neutral-400">Error Rate</p>
                </div>
                <div class="mt-1 flex items-center gap-x-2">
                    <h3 class="text-xl sm:text-2xl font-medium text-gray-800 dark:text-neutral-200"><span x-text="(stats.error_rate * 100).toFixed(2)">0</span>%</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid lg:grid-cols-2 gap-4 sm:gap-6">
        <!-- Request Volume Chart -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="px-6 py-4 flex justify-between items-center border-b border-gray-200 dark:border-neutral-700">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">Request Volume</h2>
                    <p class="text-sm text-gray-600 dark:text-neutral-400">Last 24 hours</p>
                </div>
                <select x-model="timeRange" @change="updateCharts()" class="py-2 px-3 pe-9 block border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400">
                    <option value="1h">Last hour</option>
                    <option value="24h" selected>Last 24h</option>
                    <option value="7d">Last 7 days</option>
                    <option value="30d">Last 30 days</option>
                </select>
            </div>
            <div class="p-6">
                <div id="hs-request-volume-chart"></div>
            </div>
        </div>

        <!-- Latency Distribution Chart -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-neutral-700">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">Latency Distribution</h2>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Response time percentiles</p>
            </div>
            <div class="p-6">
                <div id="hs-latency-chart"></div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid lg:grid-cols-3 gap-4 sm:gap-6">
        <!-- Status Code Distribution -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-neutral-700">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">Status Codes</h2>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Response code distribution</p>
            </div>
            <div class="p-6">
                <div id="hs-status-chart"></div>
            </div>
        </div>

        <!-- HTTP Methods -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-neutral-700">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">HTTP Methods</h2>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Traffic by method</p>
            </div>
            <div class="p-6">
                <div id="hs-method-chart"></div>
            </div>
        </div>

        <!-- System Health -->
        <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-neutral-700">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">System Resources</h2>
                <p class="text-sm text-gray-600 dark:text-neutral-400">CPU & Memory usage</p>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-neutral-300">CPU Usage</span>
                            <span class="text-sm text-gray-600 dark:text-neutral-400" x-text="stats.cpu_usage.toFixed(1) + '%'">0%</span>
                        </div>
                        <div class="flex w-full h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-neutral-700">
                            <div class="flex flex-col justify-center rounded-full overflow-hidden bg-blue-600 text-xs text-white text-center whitespace-nowrap transition duration-500" :style="`width: ${stats.cpu_usage}%`"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-neutral-300">Memory Usage</span>
                            <span class="text-sm text-gray-600 dark:text-neutral-400" x-text="stats.memory_usage.toFixed(1) + '%'">0%</span>
                        </div>
                        <div class="flex w-full h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-neutral-700">
                            <div class="flex flex-col justify-center rounded-full overflow-hidden bg-cyan-600 text-xs text-white text-center whitespace-nowrap transition duration-500" :style="`width: ${stats.memory_usage}%`"></div>
                        </div>
                    </div>
                    <div id="hs-system-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Routes Table -->
    <div class="flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-800 dark:border-neutral-700">
        <div class="px-6 py-4 flex justify-between items-center border-b border-gray-200 dark:border-neutral-700">
            <div>
                <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">Top Routes</h2>
                <p class="text-sm text-gray-600 dark:text-neutral-400">Most accessed endpoints</p>
            </div>
            <a href="/admin/routes" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent text-blue-600 hover:bg-blue-100 dark:text-blue-500 dark:hover:bg-blue-900">
                View all
                <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                <thead class="bg-gray-50 dark:bg-neutral-800">
                    <tr>
                        <th class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-400">Path</th>
                        <th class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-400">Method</th>
                        <th class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-400">Requests</th>
                        <th class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-400">Avg Latency</th>
                        <th class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-400">Error Rate</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-neutral-700" x-show="topRoutes.length > 0">
                    <template x-for="route in topRoutes" :key="route.path">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200" x-text="route.path"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200">
                                <span class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" x-text="route.method"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200" x-text="formatNumber(route.requests)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200"><span x-text="route.avg_latency.toFixed(1)"></span>ms</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200"><span x-text="(route.error_rate * 100).toFixed(2)"></span>%</td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function prelineDashboard() {
    return {
        stats: {
            total_requests: 0,
            active_routes: 0,
            avg_latency_ms: 0,
            error_rate: 0,
            cpu_usage: 0,
            memory_usage: 0,
            health_status: 'healthy'
        },
        topRoutes: [],
        timeRange: '24h',
        loading: false,
        charts: {},

        async init() {
            await this.loadStats();
            await this.loadTopRoutes();
            await this.$nextTick();
            this.initCharts();
            // Auto-refresh every 10 seconds
            setInterval(() => this.refresh(), 10000);
        },

        async loadStats() {
            try {
                const response = await fetch('/admin/api/metrics/realtime');
                if (!response.ok) throw new Error('Failed to fetch stats');
                this.stats = await response.json();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        },

        async loadTopRoutes() {
            try {
                const response = await fetch('/admin/api/analytics?timeframe=' + this.timeRange);
                if (!response.ok) throw new Error('Failed to fetch analytics');
                const data = await response.json();
                this.topRoutes = data.top_routes || [];
            } catch (error) {
                console.error('Error loading top routes:', error);
            }
        },

        async refresh() {
            this.loading = true;
            await this.loadStats();
            await this.loadTopRoutes();
            this.updateCharts();
            this.loading = false;
        },

        initCharts() {
            this.initRequestVolumeChart();
            this.initLatencyChart();
            this.initStatusChart();
            this.initMethodChart();
            this.initSystemChart();
        },

        initRequestVolumeChart() {
            const element = document.querySelector('#hs-request-volume-chart');
            if (!element || this.charts.requestVolume) return;

            window.HSStaticMethods.autoInit(["apexcharts"]);
            
            const isDark = document.documentElement.classList.contains('dark');
            
            this.charts.requestVolume = new ApexCharts(element, {
                chart: {
                    type: 'area',
                    height: 300,
                    toolbar: { show: false },
                    background: 'transparent',
                    zoom: { enabled: false }
                },
                series: [{
                    name: 'Requests',
                    data: this.generateTimeSeriesData(24)
                }],
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        opacityFrom: 0.6,
                        opacityTo: 0.1
                    }
                },
                colors: ['#3b82f6'],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: {
                            colors: isDark ? '#a3a3a3' : '#6b7280'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: isDark ? '#a3a3a3' : '#6b7280'
                        },
                        formatter: (value) => value.toLocaleString()
                    }
                },
                grid: {
                    borderColor: isDark ? '#404040' : '#e5e7eb'
                },
                tooltip: {
                    theme: isDark ? 'dark' : 'light',
                    x: {
                        format: 'HH:mm'
                    }
                }
            });
            
            this.charts.requestVolume.render();
        },

        initLatencyChart() {
            const element = document.querySelector('#hs-latency-chart');
            if (!element || this.charts.latency) return;

            const isDark = document.documentElement.classList.contains('dark');
            
            this.charts.latency = new ApexCharts(element, {
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: { show: false },
                    background: 'transparent'
                },
                series: [{
                    name: 'Latency',
                    data: [23.5, 45.2, 67.8, 123.4]
                }],
                colors: ['#06b6d4'],
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '60%'
                    }
                },
                xaxis: {
                    categories: ['P50', 'P90', 'P95', 'P99'],
                    labels: {
                        style: {
                            colors: isDark ? '#a3a3a3' : '#6b7280'
                        },
                        formatter: (value) => value + 'ms'
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: isDark ? '#a3a3a3' : '#6b7280'
                        }
                    }
                },
                grid: {
                    borderColor: isDark ? '#404040' : '#e5e7eb'
                },
                dataLabels: {
                    enabled: true,
                    formatter: (value) => value.toFixed(1) + 'ms'
                },
                tooltip: {
                    theme: isDark ? 'dark' : 'light'
                }
            });
            
            this.charts.latency.render();
        },

        initStatusChart() {
            const element = document.querySelector('#hs-status-chart');
            if (!element || this.charts.status) return;

            const isDark = document.documentElement.classList.contains('dark');
            
            this.charts.status = new ApexCharts(element, {
                chart: {
                    type: 'donut',
                    height: 280,
                    background: 'transparent'
                },
                series: [95432, 3421, 856, 522, 45],
                labels: ['200', '201', '400', '404', '500'],
                colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#dc2626'],
                legend: {
                    position: 'bottom',
                    labels: {
                        colors: isDark ? '#a3a3a3' : '#6b7280'
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%'
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    theme: isDark ? 'dark' : 'light'
                }
            });
            
            this.charts.status.render();
        },

        initMethodChart() {
            const element = document.querySelector('#hs-method-chart');
            if (!element || this.charts.method) return;

            const isDark = document.documentElement.classList.contains('dark');
            
            this.charts.method = new ApexCharts(element, {
                chart: {
                    type: 'pie',
                    height: 280,
                    background: 'transparent'
                },
                series: [75000, 18000, 4500, 2500],
                labels: ['GET', 'POST', 'PUT', 'DELETE'],
                colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                legend: {
                    position: 'bottom',
                    labels: {
                        colors: isDark ? '#a3a3a3' : '#6b7280'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    theme: isDark ? 'dark' : 'light'
                }
            });
            
            this.charts.method.render();
        },

        initSystemChart() {
            const element = document.querySelector('#hs-system-chart');
            if (!element || this.charts.system) return;

            const isDark = document.documentElement.classList.contains('dark');
            
            this.charts.system = new ApexCharts(element, {
                chart: {
                    type: 'line',
                    height: 100,
                    sparkline: { enabled: true },
                    background: 'transparent'
                },
                series: [{
                    name: 'CPU',
                    data: this.generateSparklineData(20)
                }],
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                colors: ['#3b82f6'],
                tooltip: {
                    theme: isDark ? 'dark' : 'light',
                    fixed: {
                        enabled: false
                    },
                    x: { show: false },
                    y: {
                        formatter: (value) => value.toFixed(1) + '%'
                    }
                }
            });
            
            this.charts.system.render();
        },

        updateCharts() {
            if (this.charts.requestVolume) {
                this.charts.requestVolume.updateSeries([{
                    data: this.generateTimeSeriesData(this.timeRange === '24h' ? 24 : this.timeRange === '7d' ? 7 : 30)
                }]);
            }
        },

        generateTimeSeriesData(points) {
            const data = [];
            const now = Date.now();
            const interval = this.timeRange === '24h' ? 3600000 : this.timeRange === '7d' ? 86400000 : 86400000;
            
            for (let i = points - 1; i >= 0; i--) {
                data.push({
                    x: now - (i * interval),
                    y: Math.floor(1000 + Math.random() * 500)
                });
            }
            return data;
        },

        generateSparklineData(points) {
            return Array.from({ length: points }, () => Math.floor(30 + Math.random() * 40));
        },

        formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
    };
}
</script>
{% endblock %}

